---
title: "Closing the Loop"
author: "Aidi Bian"
date: "5/5/2019"
output: html_document
---

```{r}
library(twitteR)
library(RCurl)
library(ROAuth)
```

## Twitter Setup

Step 1. Create a Twitter account at Twitter.com and register as a developer at the following link: https://developer.twitter.com/

Step 2. Register a new app (we need to create an app to access the API as that is what the primary us of the API is) at https://apps.twitter.com/

Step 3. Within R, install the packages ROAuth and twitteR

Step 4. Copy the details from Twitter App page.

```{r}
api_key <- "NAoTAYzkQKOgVhKB3mjjEtnxQ"

api_secret <- "y5N5F1sHSfzOoQ2JQy4izUnTDW319PZze0axvbIuCVo97lGpQD"

access_token <- "1118281169433501696-Jxi8X8XSpVce95JY1Qn5YoJKcNs0Ra"

access_token_secret <- "VZjv6qTzB5342FSeuRrNhjji61rtNZtATLnjocl7WbUGg"

setup_twitter_oauth(api_key, api_secret, access_token, access_token_secret)
```

I can now download Tweets (but I can only search from the previous 6-7 days). Limit the number of tweets when searching for a popular term using `n=`

### Download Tweets
```{r}
library(dplyr)
TL1 <- searchTwitter("education data", n=300, since='2019-04-30', until='2019-05-01')
TL2 <- searchTwitter("education data", n=300, since='2019-05-02', until='2019-05-03')
TL1 <- do.call("rbind", lapply(TL1, as.data.frame))
TL2 <- do.call("rbind", lapply(TL2, as.data.frame))
TL<-as.data.frame(bind_rows(TL1, TL2))
```

Look at the data that Twitter has made available and do a quick visualization of Tweets over time.

```{r}
counts=table(TL$screenName)
barplot(counts, las=2)

#By time of day
hist(TL1$created, breaks = "h")
hist(TL2$created, breaks = "h")
```


## Setup auto-email

To set up an autogenerated email we need to install both the sendmailR and cronR packages. The cronR package is a scheduling package that connects to the cron system on the computer while sendmailR gives you access to your gmail account. 

```{r}
library(sendmailR)
library(cronR)

#Email
sendmail_options(smtpServer="ASPMX.L.GOOGLE.COM")
address <- as.character("ab4499@tc.columbia.edu")
address <- paste("<", address, ">", sep = "")

from <- "<ab4499@tc.columbia.edu>"
to <- address
subject <- "Notice from Tweeter"
body <- c(
  "This is a email from Tweet Notification. Please check your Tweet account."
)

sendmail(from, to, subject, body)

```

Investigate the Chron Scheduler 

```{r}
install.packages('data.table')
install.packages('knitr')
install.packages('miniUI')
install.packages('shiny')
install.packages("taskscheduleR", repos = "http://www.datatailor.be/rcube", type = "source")
install.packages("shinyFiles")
```


https://www.bnosac.be/index.php/blog/51-new-rstudio-add-in-to-schedule-r-scripts

Use the scheduler to schedule an email to myself.

## Threshold Generate

Set the scheduler to send an email triggered by an activity threshold on Twitter. For example, an email is sent if a certain number of Tweets are returned by the search.

```{r}
if(nrow(TL1)>100){
  sendmail_options(smtpServer="ASPMX.L.GOOGLE.COM")
  address <- as.character("ab4499@tc.columbia.edu")
  address <- paste("<", address, ">", sep = "")
  
  from <- "<ab4499@tc.columbia.edu>"
  to <- address
  subject <- "Notice from Tweeter"
  body <- c(
  "This is a email to notify that the search is more than 100. Please check your Tweet account."
  )
  sendmail(from, to, subject, body)
}
```

